<section class="dashboard">
	<div class="grid">
		<mat-card appearance="outlined" class="leaderboard">
			<mat-card-header>
				<mat-card-title>Top performing cars</mat-card-title>
				<mat-card-subtitle>Based on average renter feedback (min. 3 reviews).</mat-card-subtitle>
			</mat-card-header>
			<mat-card-content>
				<section class="loading" *ngIf="topCarsLoading()">
					<mat-progress-spinner diameter="32" mode="indeterminate"></mat-progress-spinner>
					<span>Loading leaderboard…</span>
				</section>

				<p class="error" *ngIf="topCarsError()">{{ topCarsError() }}</p>

				<ol *ngIf="!topCarsLoading() && topCars().length > 0" class="top-cars">
					<li *ngFor="let car of topCars(); index as index">
						<span class="rank">#{{ index + 1 }}</span>
						<div class="details">
							<p>Car {{ car.carsId }}</p>
							<small>{{ car.feedbackCount }} reviews</small>
						</div>
						<span class="rating">
							<mat-icon aria-hidden="true">star</mat-icon>
							{{ car.avgRating | number: '1.2-2' }}
						</span>
						<a mat-icon-button color="primary" [routerLink]="['/cars', car.carsId]">
							<mat-icon aria-hidden="true">open_in_new</mat-icon>
						</a>
					</li>
				</ol>

				<p class="muted" *ngIf="!topCarsLoading() && topCars().length === 0">
					Not enough feedback yet to build the leaderboard.
				</p>
			</mat-card-content>
		</mat-card>

		<mat-card appearance="outlined" class="insights">
			<mat-card-header>
				<mat-card-title>Car insights</mat-card-title>
				<mat-card-subtitle>Monitor rental activity for a specific vehicle.</mat-card-subtitle>
			</mat-card-header>
			<mat-card-content>
				<form class="lookup" (ngSubmit)="lookupCar()">
					<mat-form-field appearance="outline">
						<mat-label>Car ID</mat-label>
						<input matInput [formControl]="carIdControl" placeholder="e.g. 12">
						<mat-icon matSuffix aria-hidden="true">search</mat-icon>
						<mat-error *ngIf="carIdControl.hasError('required')">ID is required.</mat-error>
						<mat-error *ngIf="carIdControl.hasError('pattern')">Use digits only.</mat-error>
					</mat-form-field>
					<button mat-flat-button color="primary" type="submit">
						<mat-icon aria-hidden="true">insights</mat-icon>
						View activity
					</button>
				</form>

				<section class="loading" *ngIf="carLoading()">
					<mat-progress-spinner diameter="32" mode="indeterminate"></mat-progress-spinner>
					<span>Fetching car data…</span>
				</section>

				<p class="error" *ngIf="carError()">{{ carError() }}</p>

				<section *ngIf="selectedCar() as car" class="car-profile">
					<header>
						<h3>{{ car.brand }} {{ car.model }}</h3>
						<mat-chip color="primary" selected>{{ car.category }}</mat-chip>
					</header>
					  <p>ID · {{ car.id }} · Registration {{ car.registrationNumber || 'N/A' }}</p>
					<p>{{ car.description || 'No description available.' }}</p>
				</section>

				<section *ngIf="selectedCar()" class="history">
					<h4>Recent rentals</h4>
							<p class="muted" *ngIf="rentalsTotalElements() > 0">
								{{ rentalsTotalElements() }} booking(s) recorded for this vehicle.
							</p>

					<section class="loading" *ngIf="rentalsLoading()">
						<mat-progress-spinner diameter="28" mode="indeterminate"></mat-progress-spinner>
						<span>Loading rental history…</span>
					</section>

					<p class="error" *ngIf="rentalsError()">{{ rentalsError() }}</p>

					<ng-container *ngIf="!rentalsLoading() && rentals().length > 0; else noRentals">
						<article class="rental" *ngFor="let rental of rentals()">
							<header>
								<strong>Booking #{{ rental.id }}</strong>
								<mat-chip [ngClass]="statusClass(rental.status)" selected>
									{{ statusLabel(rental.status) }}
								</mat-chip>
							</header>
							<dl>
								<div>
									<dt>Pickup</dt>
									<dd>{{ formatInstant(rental.pickupDatetime) }}</dd>
								</div>
								<div>
									<dt>Return</dt>
									<dd>{{ formatInstant(rental.returnDatetime) }}</dd>
								</div>
								<div>
									<dt>Renter</dt>
									<dd>{{ rental.renterId }}</dd>
								</div>
								<div>
									<dt>Cost</dt>
									<dd>{{ formatCost(rental) }}</dd>
								</div>
							</dl>
							<mat-divider></mat-divider>
						</article>

						<div class="pagination">
							<button mat-stroked-button (click)="loadPrevious()" [disabled]="rentalsPage() === 0">
								<mat-icon aria-hidden="true">chevron_left</mat-icon>
								Previous
							</button>
							<span>Page {{ rentalsPage() + 1 }} / {{ rentalsTotalPages() || 1 }}</span>
							<button mat-stroked-button (click)="loadNext()" [disabled]="rentalsPage() + 1 >= rentalsTotalPages()">
								Next
								<mat-icon aria-hidden="true">chevron_right</mat-icon>
							</button>
						</div>
					</ng-container>

					<ng-template #noRentals>
						<p class="muted">No rentals recorded for this car yet.</p>
					</ng-template>
				</section>
			</mat-card-content>
		</mat-card>
	</div>
</section>
