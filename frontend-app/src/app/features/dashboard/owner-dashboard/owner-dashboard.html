<section class="max-w-7xl mx-auto">
	<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
		<mat-card appearance="outlined">
			<mat-card-header>
				<mat-card-title>Top performing cars</mat-card-title>
				<mat-card-subtitle>Based on average renter feedback (min. 3 reviews).</mat-card-subtitle>
			</mat-card-header>
			<mat-card-content>
				@if (topCarsLoading()) {
					<div class="flex items-center gap-2 py-4">
						<mat-progress-spinner diameter="32" mode="indeterminate"></mat-progress-spinner>
						<span>Loading leaderboard…</span>
					</div>
				}

				@if (topCarsError()) {
					<p class="text-red-600 font-medium">{{ topCarsError() }}</p>
				}

				@if (!topCarsLoading() && topCars().length > 0) {
					<ol class="space-y-3">
						@for (car of topCars(); track car.carsId; let index = $index) {
							<li class="flex items-center gap-3 p-3 bg-gray-50 rounded">
								<span class="font-bold text-lg text-gray-600 w-8">#{{ index + 1 }}</span>
								<div class="flex-1">
									<p class="font-medium">Car {{ car.carsId }}</p>
									<small class="text-gray-500">{{ car.feedbackCount }} reviews</small>
								</div>
								<span class="flex items-center gap-1 font-semibold text-yellow-600">
									<mat-icon aria-hidden="true">star</mat-icon>
									{{ car.avgRating | number: '1.2-2' }}
								</span>
								<a mat-icon-button color="primary" [routerLink]="['/cars', car.carsId]">
									<mat-icon aria-hidden="true">open_in_new</mat-icon>
								</a>
							</li>
						}
					</ol>
				}

				@if (!topCarsLoading() && topCars().length === 0) {
					<p class="text-gray-500">Not enough feedback yet to build the leaderboard.</p>
				}
			</mat-card-content>
		</mat-card>

		<mat-card appearance="outlined">
			<mat-card-header>
				<mat-card-title>Car insights</mat-card-title>
				<mat-card-subtitle>Monitor rental activity for a specific vehicle.</mat-card-subtitle>
			</mat-card-header>
			<mat-card-content>
				<form class="flex gap-4 mb-6" (ngSubmit)="lookupCar()">
					<mat-form-field appearance="outline" class="flex-1">
						<mat-label>Car ID</mat-label>
						<input matInput [formControl]="carIdControl" placeholder="e.g. 12">
						<mat-icon matSuffix aria-hidden="true">search</mat-icon>
						@if (carIdControl.hasError('required')) {
							<mat-error>ID is required.</mat-error>
						}
						@if (carIdControl.hasError('pattern')) {
							<mat-error>Use digits only.</mat-error>
						}
					</mat-form-field>
					<button mat-flat-button color="primary" type="submit">
						<mat-icon aria-hidden="true">insights</mat-icon>
						View activity
					</button>
				</form>

				@if (carLoading()) {
					<div class="flex items-center gap-2 py-4">
						<mat-progress-spinner diameter="32" mode="indeterminate"></mat-progress-spinner>
						<span>Fetching car data…</span>
					</div>
				}

				@if (carError()) {
					<p class="text-red-600 font-medium">{{ carError() }}</p>
				}

				@if (selectedCar(); as car) {
					<section class="mb-6 p-4 bg-gray-50 rounded">
						<header class="flex justify-between items-center mb-2">
							<h3 class="text-xl font-semibold">{{ car.brand }} {{ car.model }}</h3>
							<mat-chip color="primary" selected>{{ car.category }}</mat-chip>
						</header>
						<p class="text-sm text-gray-600">ID · {{ car.id }} · Registration {{ car.registrationNumber || 'N/A' }}</p>
						<p class="mt-2">{{ car.description || 'No description available.' }}</p>
					</section>
				}

				@if (selectedCar()) {
					<section class="space-y-4">
						<h4 class="text-lg font-semibold">Recent rentals</h4>
						@if (rentalsTotalElements() > 0) {
							<p class="text-gray-600 text-sm">
								{{ rentalsTotalElements() }} booking(s) recorded for this vehicle.
							</p>
						}

						@if (rentalsLoading()) {
							<div class="flex items-center gap-2 py-4">
								<mat-progress-spinner diameter="28" mode="indeterminate"></mat-progress-spinner>
								<span>Loading rental history…</span>
							</div>
						}

						@if (rentalsError()) {
							<p class="text-red-600 font-medium">{{ rentalsError() }}</p>
						}

						@if (!rentalsLoading() && rentals().length > 0) {
							@for (rental of rentals(); track rental.id) {
								<article class="border rounded-lg p-4 space-y-3">
									<header class="flex justify-between items-center">
										<strong>Booking #{{ rental.id }}</strong>
										<mat-chip [ngClass]="statusClass(rental.status)" selected>
											{{ statusLabel(rental.status) }}
										</mat-chip>
									</header>
									<dl class="grid grid-cols-2 gap-3 text-sm">
										<div>
											<dt class="text-gray-600">Pickup</dt>
											<dd class="font-medium">{{ formatInstant(rental.pickupDatetime) }}</dd>
										</div>
										<div>
											<dt class="text-gray-600">Return</dt>
											<dd class="font-medium">{{ formatInstant(rental.returnDatetime) }}</dd>
										</div>
										<div>
											<dt class="text-gray-600">Renter</dt>
											<dd class="font-medium">{{ rental.renterId }}</dd>
										</div>
										<div>
											<dt class="text-gray-600">Cost</dt>
											<dd class="font-medium">{{ formatCost(rental) }}</dd>
										</div>
									</dl>
									<mat-divider></mat-divider>
								</article>
							}

							<div class="flex justify-between items-center">
								<button mat-stroked-button (click)="loadPrevious()" [disabled]="rentalsPage() === 0">
									<mat-icon aria-hidden="true">chevron_left</mat-icon>
									Previous
								</button>
								<span>Page {{ rentalsPage() + 1 }} / {{ rentalsTotalPages() || 1 }}</span>
								<button mat-stroked-button (click)="loadNext()" [disabled]="rentalsPage() + 1 >= rentalsTotalPages()">
									Next
									<mat-icon aria-hidden="true">chevron_right</mat-icon>
								</button>
							</div>
						} @else if (!rentalsLoading()) {
							<p class="text-gray-500">No rentals recorded for this car yet.</p>
						}
					</section>
				}
			</mat-card-content>
		</mat-card>
	</div>
</section>